# 🚀 AI股市预测系统部署指南

## 📋 目录
- [系统要求](#系统要求)
- [快速部署](#快速部署)
- [详细部署步骤](#详细部署步骤)
- [配置说明](#配置说明)
- [监控与维护](#监控与维护)
- [故障排除](#故障排除)

## 💻 系统要求

### 硬件要求
- **CPU**: 4核心以上，推荐8核心
- **内存**: 8GB以上，推荐16GB
- **存储**: 50GB以上可用空间
- **GPU**: 可选，用于深度学习模型加速

### 软件要求
- **操作系统**: Linux (Ubuntu 20.04+推荐) / Windows 10+ / macOS 10.15+
- **Python**: 3.9+
- **Docker**: 20.10+ (推荐使用Docker部署)
- **Docker Compose**: 2.0+

## 🚀 快速部署

### 方式一：Docker部署（推荐）

```bash
# 1. 克隆项目
git clone <项目地址>
cd AI股市预测系统

# 2. 创建环境配置文件
cp .env.example .env
vim .env  # 编辑配置

# 3. 启动所有服务
docker-compose up -d

# 4. 查看服务状态
docker-compose ps

# 5. 访问系统
# Web界面: http://localhost:8501
# API文档: http://localhost:8000/docs
```

### 方式二：本地部署

```bash
# 1. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate   # Windows

# 2. 安装依赖
pip install -r requirements.txt

# 3. 准备数据目录
mkdir -p datas_em models logs

# 4. 启动Redis（可选，用于缓存）
redis-server

# 5. 启动API服务
uvicorn prediction_service:app --host 0.0.0.0 --port 8000 &

# 6. 启动Web界面
streamlit run streamlit_app.py --server.port 8501
```

## 📖 详细部署步骤

### 1. 环境准备

#### 安装Docker和Docker Compose
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.12.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 配置系统资源
```bash
# 增加文件描述符限制
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# 配置内存映射限制
echo "vm.max_map_count=262144" >> /etc/sysctl.conf
sysctl -p
```

### 2. 项目配置

#### 创建配置文件
```bash
# 创建环境变量文件
cat > .env << EOF
# 数据库配置
DB_PATH=./data/performance.db

# Redis配置
REDIS_HOST=redis
REDIS_PORT=6379

# 邮件告警配置
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
ALERT_EMAIL=admin@yourcompany.com

# 系统配置
LOG_LEVEL=INFO
MAX_WORKERS=4
CACHE_TTL=300

# 模型配置
MODEL_UPDATE_INTERVAL=86400  # 24小时
PERFORMANCE_THRESHOLD=0.55
EOF
```

#### 创建日志配置
```bash
# 创建日志目录
mkdir -p logs

# 创建日志配置文件
cat > logging.conf << EOF
[loggers]
keys=root,stock_prediction

[handlers]
keys=consoleHandler,fileHandler

[formatters]
keys=simpleFormatter

[logger_root]
level=INFO
handlers=consoleHandler,fileHandler

[logger_stock_prediction]
level=INFO
handlers=consoleHandler,fileHandler
qualname=stock_prediction
propagate=0

[handler_consoleHandler]
class=StreamHandler
level=INFO
formatter=simpleFormatter
args=(sys.stdout,)

[handler_fileHandler]
class=FileHandler
level=INFO
formatter=simpleFormatter
args=('logs/stock_prediction.log',)

[formatter_simpleFormatter]
format=%(asctime)s - %(name)s - %(levelname)s - %(message)s
EOF
```

### 3. 数据准备

#### 创建数据目录结构
```bash
mkdir -p datas_em
mkdir -p models
mkdir -p stockcode_list
mkdir -p backup
```

#### 初始化股票代码列表
```bash
# 创建股票代码列表文件
cat > stockcode_list/all_stock_list.csv << EOF
股票代码,股票名称
sh600519,贵州茅台
sz000001,平安银行
sz000002,万科A
sh600036,招商银行
sz000858,五粮液
EOF
```

### 4. 启动服务

#### 使用Docker Compose部署
```bash
# 构建并启动所有服务
docker-compose up --build -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f stock-prediction
docker-compose logs -f redis
docker-compose logs -f monitor
```

#### 服务验证
```bash
# 检查API服务
curl http://localhost:8000/

# 检查Web界面
curl http://localhost:8501/

# 检查Redis连接
docker-compose exec redis redis-cli ping
```

### 5. SSL配置（生产环境）

#### 生成SSL证书
```bash
# 创建SSL目录
mkdir -p ssl

# 生成自签名证书（测试用）
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout ssl/private.key \
    -out ssl/certificate.crt \
    -subj "/C=CN/ST=State/L=City/O=Company/CN=yourdomain.com"

# 生产环境推荐使用Let's Encrypt
# certbot certonly --standalone -d yourdomain.com
```

#### Nginx配置
```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream stock_prediction {
        server stock-prediction:8000;
    }
    
    upstream streamlit {
        server stock-prediction:8501;
    }
    
    server {
        listen 80;
        listen 443 ssl;
        server_name yourdomain.com;
        
        ssl_certificate /etc/nginx/ssl/certificate.crt;
        ssl_certificate_key /etc/nginx/ssl/private.key;
        
        # API服务
        location /api/ {
            proxy_pass http://stock_prediction/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # Web界面
        location / {
            proxy_pass http://streamlit/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
```

## ⚙️ 配置说明

### 环境变量配置

| 变量名 | 描述 | 默认值 | 示例 |
|--------|------|--------|------|
| `DB_PATH` | 性能数据库路径 | `./performance.db` | `/app/data/performance.db` |
| `REDIS_HOST` | Redis主机地址 | `localhost` | `redis` |
| `REDIS_PORT` | Redis端口 | `6379` | `6379` |
| `LOG_LEVEL` | 日志级别 | `INFO` | `DEBUG` |
| `MODEL_UPDATE_INTERVAL` | 模型更新间隔(秒) | `86400` | `3600` |
| `PERFORMANCE_THRESHOLD` | 性能阈值 | `0.55` | `0.60` |

### 模型配置

```python
# config.py
MODEL_CONFIG = {
    'sequence_length': 60,        # 时序窗口长度
    'prediction_days': [1, 3, 5], # 支持的预测天数
    'batch_size': 32,             # 训练批次大小
    'epochs': 100,                # 训练轮数
    'early_stopping_patience': 15, # 早停耐心值
    'learning_rate': 0.001,       # 学习率
    'dropout_rate': 0.3,          # Dropout比率
}

ENSEMBLE_WEIGHTS = {
    'LSTM': 0.4,
                'LightGBM': 0.3,
    'Transformer': 0.2,
    'CNN-LSTM': 0.1
}
```

## 📊 监控与维护

### 系统监控

#### 监控指标
- **性能指标**: 准确率、精确率、召回率、F1分数
- **系统指标**: CPU使用率、内存使用率、磁盘使用率
- **服务指标**: API响应时间、请求成功率、缓存命中率

#### 监控命令
```bash
# 查看系统资源使用
docker stats

# 查看服务日志
docker-compose logs -f --tail=100 stock-prediction

# 查看数据库大小
du -sh data/performance.db

# 查看模型文件
ls -la models/
```

### 定期维护

#### 每日维护任务
```bash
#!/bin/bash
# daily_maintenance.sh

# 清理旧日志
find logs/ -name "*.log" -mtime +30 -delete

# 备份数据库
cp data/performance.db backup/performance_$(date +%Y%m%d).db

# 检查磁盘空间
df -h

# 重启服务（如需要）
# docker-compose restart stock-prediction
```

#### 每周维护任务
```bash
#!/bin/bash
# weekly_maintenance.sh

# 清理Docker镜像
docker system prune -f

# 更新股票代码列表
python update_stock_list.py

# 性能报告
python generate_weekly_report.py

# 模型性能检查
python check_model_performance.py
```

### 备份策略

#### 数据备份
```bash
# 创建备份脚本
cat > backup.sh << EOF
#!/bin/bash
BACKUP_DIR="backup/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 备份数据库
cp data/performance.db $BACKUP_DIR/

# 备份模型
cp -r models/ $BACKUP_DIR/

# 备份配置
cp .env $BACKUP_DIR/
cp docker-compose.yml $BACKUP_DIR/

# 压缩备份
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz $BACKUP_DIR
rm -rf $BACKUP_DIR

echo "备份完成: backup_$(date +%Y%m%d_%H%M%S).tar.gz"
EOF

chmod +x backup.sh

# 设置定时任务
echo "0 2 * * * /path/to/backup.sh" | crontab -
```

## 🔧 故障排除

### 常见问题

#### 1. 服务启动失败
```bash
# 检查端口占用
netstat -tlnp | grep :8000
netstat -tlnp | grep :8501

# 检查Docker服务
systemctl status docker

# 查看详细错误日志
docker-compose logs stock-prediction
```

#### 2. 内存不足
```bash
# 查看内存使用
free -h
docker stats

# 调整Docker内存限制
# 在docker-compose.yml中添加:
# deploy:
#   resources:
#     limits:
#       memory: 4G
```

#### 3. 模型加载失败
```bash
# 检查模型文件
ls -la models/

# 重新训练模型
python training_pipeline.py

# 检查模型兼容性
python -c "import joblib; print(joblib.__version__)"
```

#### 4. 数据更新问题
```bash
# 检查数据目录权限
ls -la datas_em/

# 手动更新数据
python 2.1获取全数据（东财）.py

# 检查网络连接
curl -I http://quote.eastmoney.com
```

#### 5. 性能下降
```bash
# 检查模型性能
python performance_monitor.py

# 重新训练模型
python training_pipeline.py --retrain-all

# 清理缓存
redis-cli FLUSHALL
```

### 日志分析

#### 重要日志位置
- **应用日志**: `logs/stock_prediction.log`
- **API日志**: `logs/fastapi.log`
- **系统日志**: `/var/log/syslog`
- **Docker日志**: `docker-compose logs`

#### 日志分析命令
```bash
# 查看错误日志
grep "ERROR" logs/stock_prediction.log | tail -50

# 统计API调用
grep "POST /predict" logs/fastapi.log | wc -l

# 查看性能指标
grep "accuracy" logs/stock_prediction.log | tail -20

# 监控实时日志
tail -f logs/stock_prediction.log | grep -E "(ERROR|WARNING)"
```

## 📞 技术支持

### 联系方式
- **技术支持邮箱**: support@yourcompany.com
- **紧急联系电话**: +86-xxx-xxxx-xxxx
- **在线文档**: https://docs.yourcompany.com

### 社区支持
- **GitHub Issues**: 项目问题反馈
- **用户论坛**: 用户交流社区
- **技术博客**: 最新技术文章

---

## 📝 更新日志

### v1.0.0 (2024-01-01)
- ✅ 初始版本发布
- ✅ 多模型融合预测系统
- ✅ Web界面和API服务
- ✅ 性能监控和自动优化
- ✅ Docker容器化部署

### 未来规划
- 🔄 支持更多数据源
- 🔄 增加更多技术指标
- 🔄 优化模型训练速度
- 🔄 增加移动端支持

---

*祝您使用愉快！如有问题，请及时联系技术支持团队。*