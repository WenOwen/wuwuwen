# 🚀 日频多源股票预测训练系统

基于深度学习的股票收益率预测系统，融合个股、板块、指数和情绪多源数据，使用Siamese-LSTM + 时间注意力机制进行训练。

## 📊 项目概览

- **模型架构**: Siamese-LSTM + Temporal Attention
- **数据频率**: 日频
- **特征维度**: 27维（个股15维 + 板块5维 + 指数5维 + 情绪2维）
- **时间窗口**: 30天滑动窗口
- **训练样本**: 22,092个样本，涵盖47只股票
- **预测目标**: 次日股票收益率

## 🏗️ 系统架构

### 数据流程
```
原始数据 → 特征工程 → 多源融合 → 时间序列构建 → 模型训练 → 预测评估
```

### 特征构成
| 数据源 | 维度 | 内容 | 说明 |
|--------|------|------|------|
| **个股特征** | 15维 | OHLCV + 技术指标 | RSI、MACD、布林带等 |
| **板块特征** | 5维 | 所属行业指数OHLCV | 仅使用股票对应的单一行业 |
| **指数特征** | 5维 | 大盘指数 + 波动率 | 上证、深证、创业板等 |
| **情绪特征** | 2维 | 涨停强度 + 连板强度 | 市场情绪和投机热度 |

## 🛠️ 技术特点

### 核心创新
- **精准板块映射**: 每只股票仅使用其所属行业特征，避免维度爆炸
- **多源数据融合**: 整合4类不同数据源，提升预测能力
- **时间注意力机制**: 自动学习不同时间点的重要性
- **滚动窗口训练**: 模拟真实交易环境

### 模型架构
```python
Input(30, 27) → LSTM(64, 2层) → Temporal Attention → FC(1) → 收益率预测
```

## 📦 安装使用

### 环境要求
- Python 3.8+
- CUDA 11.0+ (GPU训练)
- 内存: 8GB+
- 存储: 2GB+

### 快速开始

1. **环境配置**
```bash
# 创建虚拟环境
conda create -n quant python=3.8
conda activate quant

# 安装依赖
pip install -r requirements.txt
```

2. **数据准备**
```bash
# 将原始数据放入对应目录
data/
├── datas_em/                    # 个股日线数据
├── datas_sector_historical/     # 板块历史数据
│   ├── 行业板块_全部历史/       # 行业板块
│   ├── 概念板块_全部历史/       # 概念板块（情绪数据）
│   └── 股票板块映射表.csv       # 股票-行业映射
└── datas_index/                 # 指数数据
```

3. **数据处理**
```bash
# 运行数据处理脚本（如果需要重新处理）
python improved_data_processor.py
```

4. **模型训练**
```bash
# 开始训练
python train.py
```

## 📈 训练结果

### 性能指标
- **样本数量**: 22,092个训练样本
- **特征维度**: 27维多源融合特征
- **时间跨度**: 30天历史窗口
- **股票数量**: 47只A股

### 模型配置
```python
模型参数:
- LSTM隐藏层: 64维，2层
- Dropout: 0.3
- 优化器: AdamW (lr=1e-3, weight_decay=1e-4)
- 学习率调度: CosineAnnealingLR
- 早停策略: 5个epoch无改善
```

## 📁 项目结构

```
wuwuwen/
├── train.py                     # 🚀 主训练脚本
├── model.py                     # 🧠 模型定义
├── monitoring.py                # 📊 监控工具
├── requirements.txt             # 📦 依赖包
├── data/                        # 📂 数据目录
│   ├── datas_em/               # 个股数据
│   ├── datas_sector_historical/ # 板块数据
│   ├── datas_index/            # 指数数据
│   └── processed_v2/           # 处理后数据
│       ├── X_features.npy      # 特征矩阵(22092,30,27)
│       ├── y_targets.npy       # 目标向量(22092,)
│       ├── stock_codes.json    # 股票代码
│       └── data_info.json      # 数据信息
└── results_improved/           # 🎯 训练结果
    ├── best_model.pth         # 最佳模型
    ├── training_history.csv   # 训练历史
    ├── final_metrics.json     # 最终指标
    ├── training_history.png   # 训练曲线
    └── prediction_analysis.png # 预测分析
```

## 🔧 核心模块

### 数据处理 (`improved_data_processor.py`)
- **多源数据加载**: 自动加载个股、板块、指数、情绪数据
- **特征工程**: 技术指标计算、标准化、PCA降维
- **时间对齐**: 确保所有数据源按交易日对齐
- **样本生成**: 构建30天滑动窗口样本

### 模型训练 (`train.py`)
- **数据加载**: 读取预处理数据
- **模型构建**: Siamese-LSTM + 注意力机制
- **训练循环**: 早停、学习率调度、梯度裁剪
- **结果保存**: 模型、指标、可视化图表

### 模型定义 (`model.py`)
- **SiameseLSTMModel**: 主预测模型
- **TemporalAttention**: 时间注意力机制
- **ModelEvaluator**: 评估指标计算

## 📊 评估指标

### 主要指标
- **IC (Information Coefficient)**: 信息系数，预测与实际收益的相关性
- **Rank IC**: 排序信息系数，基于排序的相关性
- **MSE**: 均方误差
- **R²**: 决定系数

### 可视化
- 训练曲线：Loss、IC、Rank IC变化
- 预测分析：预测vs实际散点图、残差分析
- 注意力权重：时间步重要性可视化

## ⚡ 使用技巧

### 性能优化
```bash
# GPU训练（推荐）
export CUDA_VISIBLE_DEVICES=0
python train.py

# 调整批大小（根据显存）
# train.py中修改 batch_size=64/128/256
```

### 数据更新
```bash
# 更新训练数据
1. 将新数据放入对应目录
2. 重新运行: python improved_data_processor.py
3. 开始训练: python train.py
```

### 模型调优
```python
# model.py中调整超参数
hidden_dim = 64      # LSTM隐藏层大小
num_layers = 2       # LSTM层数
dropout = 0.3        # Dropout比例
```

## 🎯 核心特色

### 1. 智能板块特征处理
- **问题**: 传统方法将86个行业作为独立序列，导致维度爆炸
- **解决**: 每只股票仅使用其所属行业的5维特征
- **效果**: 维度从435降至5，训练效率大幅提升

### 2. 多源数据融合
- **个股基本面**: OHLCV + 技术指标
- **行业趋势**: 所属行业指数走势
- **市场环境**: 大盘指数和波动率
- **情绪因子**: 涨停连板热度

### 3. 时间注意力机制
- 自动学习30天窗口中每天的重要性
- 避免简单平均或最后一天偏置
- 提升模型对时序模式的捕捉能力

## 🔍 情绪特征详解

### 涨停和连板2维特征
```python
# 情绪特征来源
涨停强度 = 涨停相关概念板块的平均涨跌幅
连板强度 = 连板相关概念板块的平均涨跌幅
```

**数据来源**: 从概念板块历史数据中提取
- 搜索包含"涨停"、"连板"关键词的板块
- 使用板块涨跌幅作为情绪强度指标
- 如未找到相关板块，使用高波动概念板块替代

**经济含义**:
- **涨停强度**: 反映市场对涨停现象的关注度和投机情绪
- **连板强度**: 反映市场对连续涨停的热度，代表极端情绪

## 📝 开发历程

### 已实现功能
- ✅ 多源数据处理和融合
- ✅ 27维特征工程
- ✅ Siamese-LSTM模型
- ✅ 时间注意力机制
- ✅ 完整训练流程
- ✅ 可视化分析

### 技术亮点
- **精准映射**: 使用真实股票-行业映射表，确保特征准确性
- **数据对齐**: 自动处理交易日对齐和缺失值
- **内存优化**: 高效的数据处理和存储格式
- **可扩展性**: 模块化设计，易于添加新数据源

### 后续改进方向
- [ ] 增加更多技术指标
- [ ] 实现在线学习模式
- [ ] 集成更多情绪数据源
- [ ] 添加风险管理模块
- [ ] 实现实时预测API

## 🚨 注意事项

### 训练建议
- **数据质量**: 确保原始数据完整性和准确性
- **内存管理**: 大数据集训练时注意内存使用
- **超参调优**: 根据数据特点调整模型参数
- **过拟合**: 使用早停和正则化防止过拟合

### 风险提示
- 本系统仅供学习研究使用
- 预测结果不构成投资建议
- 金融市场存在不确定性，请谨慎使用

## 🤝 贡献指南

欢迎提交Issue和PR！主要改进方向：
- 新的特征工程思路
- 模型架构优化
- 训练策略改进
- 评估指标扩展

## 📞 技术支持

如有问题，请通过以下方式联系：
- 提交GitHub Issue
- 查看训练日志和错误信息
- 参考代码注释和文档

## 📄 许可证

本项目遵循MIT许可证，仅供学习研究使用。

---

*让AI赋能量化投资，构建智能的多源股票预测系统 🚀*