# ğŸ“Š å¤šæºè‚¡ç¥¨æ•°æ®å¤„ç†æµç¨‹è¯¦è§£

> åŸºäº `è‚¡æ¿æŒ‡æƒ…æ•°æ®æ±‡æ€»å¤„ç†.py` çš„å®Œæ•´æ•°æ®å¤„ç†æµç¨‹åˆ†æ

## ğŸ¯ **å¤„ç†ç›®æ ‡**

å°†å¤šæºå¼‚æ„çš„è‚¡ç¥¨ç›¸å…³æ•°æ®è½¬æ¢ä¸ºç»Ÿä¸€çš„æ·±åº¦å­¦ä¹ è®­ç»ƒæ•°æ®é›†ï¼Œå®ç°ï¼š
- **ä¸ªè‚¡ç‰¹å¾** + **è¡Œä¸šç‰¹å¾** + **æŒ‡æ•°ç‰¹å¾** + **æƒ…ç»ªç‰¹å¾** çš„å¤šæºèåˆ
- æ¯åªè‚¡ç¥¨ä»…ä½¿ç”¨å…¶**æ‰€å±è¡Œä¸š**ç‰¹å¾ï¼Œé¿å…ç»´åº¦çˆ†ç‚¸
- æ„å»º30å¤©å†å²çª—å£é¢„æµ‹æ¬¡æ—¥æ”¶ç›Šç‡çš„æ—¶åºæ ·æœ¬

---

## ğŸ“‚ **æ•°æ®è¾“å…¥æº**

### **ç›®å½•ç»“æ„**
```
./data/                                          # æ•°æ®æ ¹ç›®å½•
â”œâ”€â”€ datas_em/                                    # ğŸ“Š ä¸ªè‚¡æ—¥çº¿æ•°æ®
â”‚   â”œâ”€â”€ sz000001.csv                            # å¹³å®‰é“¶è¡Œ
â”‚   â”œâ”€â”€ sz000002.csv                            # ä¸‡ç§‘A
â”‚   â””â”€â”€ ...                                     # å…¶ä»–è‚¡ç¥¨æ–‡ä»¶
â”œâ”€â”€ datas_sector_historical/                     # ğŸ“ˆ æ¿å—å†å²æ•°æ®
â”‚   â”œâ”€â”€ è¡Œä¸šæ¿å—_å…¨éƒ¨å†å²/                       # è¡Œä¸šæ¿å—æ–‡ä»¶å¤¹
â”‚   â”‚   â”œâ”€â”€ é“¶è¡Œ(BK0475)_daily_å†å²æ•°æ®.csv      # é“¶è¡Œè¡Œä¸š
â”‚   â”‚   â”œâ”€â”€ åŒ»è¯å•†ä¸š(BK0727)_daily_å†å²æ•°æ®.csv   # åŒ»è¯è¡Œä¸š
â”‚   â”‚   â””â”€â”€ ...                                 # å…¶ä»–è¡Œä¸šæ–‡ä»¶
â”‚   â”œâ”€â”€ æ¦‚å¿µæ¿å—_å…¨éƒ¨å†å²/                       # æ¦‚å¿µæ¿å—æ–‡ä»¶å¤¹
â”‚   â”‚   â”œâ”€â”€ é¸¡è‚‰æ¦‚å¿µ(BK0887)_daily_å†å²æ•°æ®.csv  # æ¦‚å¿µæ¿å—
â”‚   â”‚   â””â”€â”€ ...                                 # å…¶ä»–æ¦‚å¿µæ–‡ä»¶
â”‚   â””â”€â”€ è‚¡ç¥¨æ¿å—æ˜ å°„è¡¨.csv                       # ğŸ”— è‚¡ç¥¨-è¡Œä¸šæ˜ å°„å…³ç³»
â””â”€â”€ datas_index/datas_index/                     # ğŸ“‰ æŒ‡æ•°æ•°æ®
    â”œâ”€â”€ zs000001.csv                            # ä¸Šè¯æŒ‡æ•°
    â”œâ”€â”€ zs000300.csv                            # æ²ªæ·±300
    â”œâ”€â”€ zs399001.csv                            # æ·±è¯æˆæŒ‡
    â”œâ”€â”€ zs399006.csv                            # åˆ›ä¸šæ¿æŒ‡
    â””â”€â”€ zs000905.csv                            # ä¸­è¯500
```

### **æ ¸å¿ƒæ˜ å°„æ–‡ä»¶ï¼šè‚¡ç¥¨æ¿å—æ˜ å°„è¡¨.csv**
```csv
è‚¡ç¥¨ä»£ç ,è‚¡ç¥¨åç§°,æ‰€å±è¡Œä¸š,è¡Œä¸šä»£ç 
sz000001,å¹³å®‰é“¶è¡Œ,é“¶è¡Œ,BK0475
sz000002,ä¸‡ç§‘A,æˆ¿åœ°äº§å¼€å‘,BK0451
...
```

---

## âš™ï¸ **æ•°æ®å¤„ç†æµç¨‹**

### **ç¬¬ä¸€æ­¥ï¼šä¸ªè‚¡æ•°æ®å¤„ç† (15ç»´ç‰¹å¾)**

#### **è¾“å…¥æ ¼å¼**
```csv
äº¤æ˜“æ—¥æœŸ,å¼€ç›˜ä»·,æ”¶ç›˜ä»·,æœ€é«˜ä»·,æœ€ä½ä»·,æˆäº¤é‡,æ¶¨è·Œå¹…,æ¢æ‰‹ç‡,...
2024-01-02,10.50,10.80,10.90,10.45,1000000,2.85,1.2,...
2024-01-03,10.75,10.65,10.85,10.60,800000,-1.39,0.9,...
```

#### **ç‰¹å¾å·¥ç¨‹**
```python
# åŸºç¡€å¸‚åœºæ•°æ® (7ç»´)
['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'æœ€é«˜ä»·', 'æœ€ä½ä»·', 'æˆäº¤é‡', 'æ¶¨è·Œå¹…', 'æ¢æ‰‹ç‡']

# æŠ€æœ¯æŒ‡æ ‡ (8ç»´)
['RSI',           # ç›¸å¯¹å¼ºå¼±æŒ‡æ•° (14æ—¥)
 'MACD',          # MACDå·®ç¦»å€¼
 'MACD_signal',   # MACDä¿¡å·çº¿
 'BB_upper',      # å¸ƒæ—å¸¦ä¸Šè½¨ (20æ—¥Â±2Ïƒ)
 'BB_middle',     # å¸ƒæ—å¸¦ä¸­è½¨ (20æ—¥å‡çº¿)
 'BB_lower',      # å¸ƒæ—å¸¦ä¸‹è½¨ (20æ—¥-2Ïƒ)
 'ATR',           # å¹³å‡çœŸå®æ³¢å¹… (14æ—¥)
 'ROC']           # å˜åŠ¨ç‡æŒ‡æ ‡ (12æ—¥)
```

#### **æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ–¹æ³•**
```python
# RSIè®¡ç®— (ç›¸å¯¹å¼ºå¼±æŒ‡æ•°)
def calculate_rsi(prices, period=14):
    delta = prices.diff()
    gain = delta.where(delta > 0, 0).rolling(period).mean()
    loss = -delta.where(delta < 0, 0).rolling(period).mean()
    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

# MACDè®¡ç®—
def calculate_macd(prices, fast=12, slow=26, signal=9):
    exp1 = prices.ewm(span=fast).mean()    # å¿«çº¿EMA
    exp2 = prices.ewm(span=slow).mean()    # æ…¢çº¿EMA
    macd = exp1 - exp2                     # MACDçº¿
    signal_line = macd.ewm(span=signal).mean()  # ä¿¡å·çº¿
    return macd, signal_line

# å¸ƒæ—å¸¦è®¡ç®—
def calculate_bollinger_bands(prices, period=20, std_dev=2):
    middle = prices.rolling(period).mean()      # ä¸­è½¨
    std = prices.rolling(period).std()          # æ ‡å‡†å·®
    upper = middle + (std * std_dev)            # ä¸Šè½¨
    lower = middle - (std * std_dev)            # ä¸‹è½¨
    return upper, middle, lower
```

### **ç¬¬äºŒæ­¥ï¼šè¡Œä¸šæ¿å—æ•°æ®å¤„ç† (5ç»´ç‰¹å¾)**

#### **æ ¸å¿ƒåˆ›æ–°ï¼šç²¾å‡†æ¿å—æ˜ å°„**
```python
# âŒ ä¼ ç»Ÿæ–¹æ³• - ç»´åº¦çˆ†ç‚¸é—®é¢˜
86ä¸ªè¡Œä¸š Ã— 5ç»´ç‰¹å¾ = 430ç»´ç‰¹å¾
â†’ å‚æ•°è¿‡å¤šï¼Œè®­ç»ƒå›°éš¾ï¼Œå®¹æ˜“è¿‡æ‹Ÿåˆ

# âœ… æ”¹è¿›æ–¹æ¡ˆ - ç²¾å‡†æ˜ å°„
æ¯åªè‚¡ç¥¨ â†’ æŸ¥æ‰¾æ‰€å±è¡Œä¸š â†’ ä»…ä½¿ç”¨è¯¥è¡Œä¸š5ç»´ç‰¹å¾
å¹³å®‰é“¶è¡Œ(sz000001) â†’ é“¶è¡Œè¡Œä¸š â†’ é“¶è¡Œè¡Œä¸š5ç»´OHLCV
ä¸‡ç§‘A(sz000002) â†’ æˆ¿åœ°äº§è¡Œä¸š â†’ æˆ¿åœ°äº§è¡Œä¸š5ç»´OHLCV
```

#### **æ˜ å°„é€»è¾‘å®ç°**
```python
# 1. è¯»å–è‚¡ç¥¨-è¡Œä¸šæ˜ å°„è¡¨
stock_sector_mapping = {
    'sz000001': 'é“¶è¡Œ',
    'sz000002': 'æˆ¿åœ°äº§å¼€å‘',
    ...
}

# 2. åŠ è½½æ‰€æœ‰è¡Œä¸šæ•°æ®
sector_data_dict = {
    'é“¶è¡Œ': DataFrame(...),         # é“¶è¡Œè¡Œä¸šOHLCVæ•°æ®
    'æˆ¿åœ°äº§å¼€å‘': DataFrame(...),   # æˆ¿åœ°äº§è¡Œä¸šOHLCVæ•°æ®
    ...
}

# 3. ä¸ºæ¯åªè‚¡ç¥¨åŒ¹é…å¯¹åº”è¡Œä¸šç‰¹å¾
for stock_code in stocks:
    sector_name = stock_sector_mapping[stock_code]  # æŸ¥æ‰¾æ‰€å±è¡Œä¸š
    sector_features = sector_data_dict[sector_name]  # è·å–è¡Œä¸šç‰¹å¾
    # ç»“æœï¼šæ¯åªè‚¡ç¥¨ä»…ä½¿ç”¨5ç»´è¡Œä¸šç‰¹å¾ï¼Œè€Œé430ç»´
```

#### **è¡Œä¸šç‰¹å¾å†…å®¹**
```python
# è¡Œä¸šæ¿å—5ç»´ç‰¹å¾ (æ¯ä¸ªè¡Œä¸šçš„æ—¥çº¿æ•°æ®)
['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'æœ€é«˜ä»·', 'æœ€ä½ä»·', 'æˆäº¤é‡']
# åæ˜ è¯¥è¡Œä¸šæ•´ä½“çš„å¸‚åœºè¡¨ç°å’Œèµ„é‡‘æµåŠ¨
```

### **ç¬¬ä¸‰æ­¥ï¼šæŒ‡æ•°æ•°æ®å¤„ç† (5ç»´ç‰¹å¾)**

#### **æŒ‡æ•°é€‰æ‹©**
```python
index_mapping = {
    'zs000001.csv': 'ä¸Šè¯æŒ‡æ•°',    # å¤§ç›˜ä»£è¡¨æ€§æŒ‡æ•°
    'zs000300.csv': 'æ²ªæ·±300',     # å¤§ç›˜è“ç­¹æŒ‡æ•°  
    'zs399001.csv': 'æ·±è¯æˆæŒ‡',    # æ·±å¸‚ä»£è¡¨æ€§æŒ‡æ•°
    'zs399006.csv': 'åˆ›ä¸šæ¿æŒ‡',    # æˆé•¿è‚¡æŒ‡æ•°
    'zs000905.csv': 'ä¸­è¯500'      # ä¸­ç›˜æŒ‡æ•°
}
```

#### **ç‰¹å¾æå–**
```python
# æå–å„æŒ‡æ•°æ”¶ç›˜ä»·ä½œä¸ºå¸‚åœºç¯å¢ƒç‰¹å¾
index_features = ['ä¸Šè¯æŒ‡æ•°', 'æ²ªæ·±300', 'æ·±è¯æˆæŒ‡', 'åˆ›ä¸šæ¿æŒ‡', 'ä¸­è¯500']
# åæ˜ ä¸åŒå¸‚åœºæ¿å—çš„æ•´ä½“èµ°åŠ¿å’Œé£é™©åå¥½
```

### **ç¬¬å››æ­¥ï¼šæƒ…ç»ªæ•°æ®å¤„ç† (2ç»´ç‰¹å¾)**

#### **æƒ…ç»ªæŒ‡æ ‡å®šä¹‰**
```python
# ä»æ¦‚å¿µæ¿å—ä¸­æå–å¸‚åœºæƒ…ç»ª
sentiment_features = ['æ¶¨åœå¼ºåº¦', 'è¿æ¿å¼ºåº¦']

# æ¶¨åœå¼ºåº¦ï¼šæ¶¨åœç›¸å…³æ¦‚å¿µæ¿å—çš„å¹³å‡æ¶¨è·Œå¹…
# è¿æ¿å¼ºåº¦ï¼šè¿æ¿ç›¸å…³æ¦‚å¿µæ¿å—çš„å¹³å‡æ¶¨è·Œå¹…
```

#### **æ•°æ®æ¥æºä¸å¤„ç†**
```python
# 1. æœç´¢ç›¸å…³æ¦‚å¿µæ¿å—æ–‡ä»¶
concept_files = glob.glob("æ¦‚å¿µæ¿å—_å…¨éƒ¨å†å²/*.csv")

# 2. ç­›é€‰æƒ…ç»ªç›¸å…³æ¿å—
limit_up_files = [f for f in concept_files if 'æ¶¨åœ' in f]
consecutive_files = [f for f in concept_files if 'è¿æ¿' in f or 'è¿ç»­' in f]

# 3. è®¡ç®—æƒ…ç»ªå¼ºåº¦
æ¶¨åœå¼ºåº¦ = mean(æ¶¨åœç›¸å…³æ¿å—.æ¶¨è·Œå¹…)
è¿æ¿å¼ºåº¦ = mean(è¿æ¿ç›¸å…³æ¿å—.æ¶¨è·Œå¹…)

# 4. å¤‡ç”¨æ–¹æ¡ˆ
if not found_sentiment_sectors:
    # ä½¿ç”¨é«˜æ³¢åŠ¨æ¦‚å¿µæ¿å—æ›¿ä»£
    use_high_volatility_sectors_as_proxy()
```

---

## ğŸ”„ **æ—¶é—´çª—å£æ„å»º**

### **æ»‘åŠ¨çª—å£æœºåˆ¶**
```python
window_size = 30  # 30å¤©å†å²çª—å£

# ä¸ºæ¯åªè‚¡ç¥¨æ„å»ºæ—¶é—´åºåˆ—æ ·æœ¬
for stock in stocks:
    for i in range(len(dates) - window_size):
        # ç‰¹å¾çª—å£ï¼šç¬¬iå¤©åˆ°ç¬¬i+29å¤© (30å¤©å†å²)
        feature_window = data[i:i+30]
        
        # é¢„æµ‹ç›®æ ‡ï¼šç¬¬i+30å¤©çš„æ”¶ç›Šç‡
        target = return[i+30]
        
        # æ ·æœ¬ç»“æ„
        sample = {
            'features': feature_window,  # shape: (30, 27)
            'target': target            # æ¬¡æ—¥æ”¶ç›Šç‡ (%)
        }
```

### **ç‰¹å¾çŸ©é˜µæ„å»º**
```python
# å•ä¸ªæ ·æœ¬çš„ç‰¹å¾æ„å»ºè¿‡ç¨‹
for each_day in window_30_days:
    # è·å–å½“æ—¥å„ç±»ç‰¹å¾
    stock_features = stock_data[day]      # 15ç»´ä¸ªè‚¡ç‰¹å¾
    sector_features = sector_data[day]    # 5ç»´è¡Œä¸šç‰¹å¾ (è¯¥è‚¡ç¥¨æ‰€å±è¡Œä¸š)
    index_features = index_data[day]      # 5ç»´æŒ‡æ•°ç‰¹å¾
    sentiment_features = sentiment_data[day]  # 2ç»´æƒ…ç»ªç‰¹å¾
    
    # æ°´å¹³æ‹¼æ¥æˆ27ç»´ç‰¹å¾å‘é‡
    daily_features = concat([
        stock_features,     # [0:15]
        sector_features,    # [15:20]  
        index_features,     # [20:25]
        sentiment_features  # [25:27]
    ])  # shape: (27,)

# 30å¤©ç‰¹å¾çª—å£
window_features = stack(daily_features_for_30_days)  # shape: (30, 27)
```

### **ç›®æ ‡å˜é‡è®¡ç®—**
```python
# æ¬¡æ—¥æ”¶ç›Šç‡è®¡ç®—
target = (next_day_close - current_close) / current_close * 100

# ç¤ºä¾‹
current_close = 10.50   # å½“å‰æ”¶ç›˜ä»·
next_day_close = 10.80  # æ¬¡æ—¥æ”¶ç›˜ä»·  
target = (10.80 - 10.50) / 10.50 * 100 = 2.86%  # æ¬¡æ—¥æ¶¨å¹…2.86%
```

---

## ğŸ”§ **æ•°æ®è´¨é‡æ§åˆ¶**

### **æ•°æ®å¯¹é½ç­–ç•¥**
```python
# 1. æ—¶é—´å¯¹é½ï¼šç¡®ä¿æ‰€æœ‰æ•°æ®æºçš„äº¤æ˜“æ—¥æœŸä¸€è‡´
common_dates = (stock_dates âˆ© sector_dates âˆ© index_dates âˆ© sentiment_dates)

# 2. æ•°æ®é‡ç´¢å¼•
stock_aligned = stock_data.reindex(common_dates)
sector_aligned = sector_data.reindex(common_dates) 
index_aligned = index_data.reindex(common_dates)
sentiment_aligned = sentiment_data.reindex(common_dates)

# 3. ç¼ºå¤±å€¼å¤„ç†
.fillna(method='ffill')  # å‰å‘å¡«å……ï¼šç”¨å‰ä¸€å¤©æ•°æ®å¡«å……
.fillna(0)               # é›¶å€¼å¡«å……ï¼šå‰©ä½™ç¼ºå¤±å€¼å¡«0
```

### **æ•°æ®éªŒè¯æ£€æŸ¥**
```python
# 1. æœ€å°æ ·æœ¬è¦æ±‚
if len(common_dates) < window_size + 1:
    skip_this_stock()  # è·³è¿‡æ•°æ®ä¸è¶³çš„è‚¡ç¥¨

# 2. ç‰¹å¾ç»´åº¦æ£€æŸ¥
assert stock_features.shape[1] == 15    # ä¸ªè‚¡ç‰¹å¾å¿…é¡»15ç»´
assert sector_features.shape[1] == 5    # è¡Œä¸šç‰¹å¾å¿…é¡»5ç»´  
assert index_features.shape[1] == 5     # æŒ‡æ•°ç‰¹å¾å¿…é¡»5ç»´
assert sentiment_features.shape[1] == 2 # æƒ…ç»ªç‰¹å¾å¿…é¡»2ç»´

# 3. ç›®æ ‡å€¼æœ‰æ•ˆæ€§
if pd.isna(target) or pd.isinf(target):
    skip_this_sample()  # è·³è¿‡æ— æ•ˆç›®æ ‡å€¼çš„æ ·æœ¬
```

---

## ğŸ“¤ **è¾“å‡ºæ•°æ®ç»“æ„**

### **æœ€ç»ˆæ•°æ®é›†æ ¼å¼**
```python
# ç‰¹å¾æ•°æ®
X_features.npy: shape = (22092, 30, 27)
â”œâ”€â”€ ç»´åº¦0: 22092ä¸ªæ ·æœ¬ (æ¥è‡ª47åªè‚¡ç¥¨çš„æ—¶é—´çª—å£)
â”œâ”€â”€ ç»´åº¦1: 30å¤©å†å²çª—å£
â””â”€â”€ ç»´åº¦2: 27ç»´èåˆç‰¹å¾
    â”œâ”€â”€ [0:15]:   ä¸ªè‚¡ç‰¹å¾ (OHLCV + æŠ€æœ¯æŒ‡æ ‡)
    â”œâ”€â”€ [15:20]:  è¡Œä¸šç‰¹å¾ (æ‰€å±è¡Œä¸šOHLCV)  
    â”œâ”€â”€ [20:25]:  æŒ‡æ•°ç‰¹å¾ (5å¤§æŒ‡æ•°æ”¶ç›˜ä»·)
    â””â”€â”€ [25:27]:  æƒ…ç»ªç‰¹å¾ (æ¶¨åœå¼ºåº¦ + è¿æ¿å¼ºåº¦)

# ç›®æ ‡æ•°æ®  
y_targets.npy: shape = (22092,)
# å¯¹åº”æ¯ä¸ªæ ·æœ¬çš„æ¬¡æ—¥æ”¶ç›Šç‡ (%)

# å…ƒæ•°æ®
stock_codes.json: è®°å½•æ¯ä¸ªæ ·æœ¬å¯¹åº”çš„è‚¡ç¥¨ä»£ç 
data_info.json: è®°å½•æ•°æ®é›†çš„è¯¦ç»†ä¿¡æ¯å’Œç»Ÿè®¡
```

### **ç‰¹å¾ç»´åº¦è¯¦è§£**
```python
feature_dimensions = {
    # ä¸ªè‚¡åŸºç¡€ç‰¹å¾ (7ç»´)
    'stock_basic': ['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'æœ€é«˜ä»·', 'æœ€ä½ä»·', 'æˆäº¤é‡', 'æ¶¨è·Œå¹…', 'æ¢æ‰‹ç‡'],
    
    # ä¸ªè‚¡æŠ€æœ¯æŒ‡æ ‡ (8ç»´)
    'stock_technical': ['RSI', 'MACD', 'MACD_signal', 'BB_upper', 'BB_middle', 'BB_lower', 'ATR', 'ROC'],
    
    # è¡Œä¸šç‰¹å¾ (5ç»´) - ä»…è¯¥è‚¡ç¥¨æ‰€å±è¡Œä¸š
    'sector': ['è¡Œä¸šå¼€ç›˜ä»·', 'è¡Œä¸šæ”¶ç›˜ä»·', 'è¡Œä¸šæœ€é«˜ä»·', 'è¡Œä¸šæœ€ä½ä»·', 'è¡Œä¸šæˆäº¤é‡'],
    
    # å¸‚åœºæŒ‡æ•° (5ç»´)  
    'index': ['ä¸Šè¯æŒ‡æ•°', 'æ²ªæ·±300', 'æ·±è¯æˆæŒ‡', 'åˆ›ä¸šæ¿æŒ‡', 'ä¸­è¯500'],
    
    # å¸‚åœºæƒ…ç»ª (2ç»´)
    'sentiment': ['æ¶¨åœå¼ºåº¦', 'è¿æ¿å¼ºåº¦']
}

total_dimensions = 7 + 8 + 5 + 5 + 2 = 27ç»´
```

---

## ğŸ’¾ **æ•°æ®ä¿å­˜ä¸å­˜å‚¨**

### **ä¿å­˜è·¯å¾„**
```
./data/processed_v2/
â”œâ”€â”€ X_features.npy      # ç‰¹å¾çŸ©é˜µ (137MB)
â”œâ”€â”€ y_targets.npy       # ç›®æ ‡å˜é‡ (173KB)
â”œâ”€â”€ stock_codes.json    # è‚¡ç¥¨ä»£ç åˆ—è¡¨ (302KB)  
â””â”€â”€ data_info.json      # æ•°æ®ä¿¡æ¯æ‘˜è¦ (284B)
```

### **æ•°æ®ä¿¡æ¯æ‘˜è¦ç¤ºä¾‹**
```json
{
  "X_shape": [22092, 30, 27],
  "y_shape": [22092],
  "feature_dims": {
    "stock": 15,
    "sector": 5,
    "index": 5, 
    "sentiment": 2,
    "total": 27
  },
  "num_samples": 22092,
  "num_stocks": 47,
  "processing_time": "2025-08-07T18:56:14.974138",
  "target_stats": {
    "mean": 0.1234,
    "std": 2.5678,
    "min": -15.67,
    "max": 12.34
  }
}
```

---

## ğŸ¯ **æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹**

### **1. ç²¾å‡†è¡Œä¸šæ˜ å°„**
```python
# ä¼ ç»Ÿé—®é¢˜
æ‰€æœ‰è‚¡ç¥¨ Ã— 86ä¸ªè¡Œä¸š Ã— 5ç»´ = å·¨å¤§ç‰¹å¾ç©ºé—´ (430ç»´)
â†’ ç»´åº¦è¯…å’’ï¼Œè®­ç»ƒå›°éš¾ï¼Œè¿‡æ‹Ÿåˆä¸¥é‡

# åˆ›æ–°è§£å†³æ–¹æ¡ˆ  
æ¯åªè‚¡ç¥¨ Ã— 1ä¸ªæ‰€å±è¡Œä¸š Ã— 5ç»´ = å›ºå®šç‰¹å¾ç©ºé—´ (5ç»´)
â†’ ç»´åº¦å¯æ§ï¼Œè®­ç»ƒé«˜æ•ˆï¼Œæ³›åŒ–æ€§å¥½

# å®ç°æ•ˆæœ
å¹³å®‰é“¶è¡Œ â†’ åªå…³æ³¨é“¶è¡Œè¡Œä¸šèµ°åŠ¿ (ç¬¦åˆä¸šåŠ¡é€»è¾‘)
ä¸‡ç§‘A â†’ åªå…³æ³¨æˆ¿åœ°äº§è¡Œä¸šèµ°åŠ¿ (ç²¾å‡†ç›¸å…³æ€§)
```

### **2. å¤šæºä¿¡æ¯èåˆ**
```python
ä¿¡æ¯æ¥æº            ç‰¹å¾ç»´åº¦    ä¸šåŠ¡ä»·å€¼
ä¸ªè‚¡åŸºæœ¬é¢         15ç»´        è‚¡ç¥¨å†…åœ¨ä»·å€¼å’ŒæŠ€æœ¯å½¢æ€
æ‰€å±è¡Œä¸šèµ°åŠ¿       5ç»´         è¡Œä¸šæ™¯æ°”åº¦å’Œèµ„é‡‘æµå‘
å¸‚åœºæ•´ä½“ç¯å¢ƒ       5ç»´         ç³»ç»Ÿæ€§é£é™©å’Œå¸‚åœºæƒ…ç»ª
æŠ•æœºæƒ…ç»ªæŒ‡æ ‡       2ç»´         çŸ­æœŸç‚’ä½œçƒ­åº¦å’Œé£é™©åå¥½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡èåˆç‰¹å¾       27ç»´        å…¨æ–¹ä½å¤šè§’åº¦ä¿¡æ¯æ•´åˆ
```

### **3. æ—¶åºå»ºæ¨¡è®¾è®¡**
```python
# è¾“å…¥ï¼š30å¤©å†å²ç‰¹å¾çª—å£
[Day-29, Day-28, ..., Day-1, Day-0]  # 30å¤© Ã— 27ç»´ç‰¹å¾

# è¾“å‡ºï¼šæ¬¡æ—¥æ”¶ç›Šç‡é¢„æµ‹  
Day+1_return = f(å†å²30å¤©å¤šæºç‰¹å¾)

# ä¼˜åŠ¿
âœ… å……åˆ†çš„å†å²ä¿¡æ¯ (30å¤© > æœˆåº¦å‘¨æœŸ)
âœ… ä¸è¿‡åº¦ä¾èµ–é•¿æœŸå†å² (é¿å…ä¿¡æ¯è¡°å‡)
âœ… é€‚åˆæ—¥é¢‘äº¤æ˜“å†³ç­– (é¢„æµ‹æ¬¡æ—¥æ”¶ç›Š)
```

---

## ğŸ“Š **æ•°æ®è´¨é‡ç»Ÿè®¡**

### **æœ€ç»ˆæ•°æ®é›†æ¦‚å†µ**
- âœ… **æ ·æœ¬è§„æ¨¡**: 22,092ä¸ªé«˜è´¨é‡è®­ç»ƒæ ·æœ¬  
- âœ… **è‚¡ç¥¨è¦†ç›–**: 47åªè‚¡ç¥¨çš„å®Œæ•´å†å²æ•°æ®
- âœ… **æ—¶é—´è·¨åº¦**: å……è¶³çš„å†å²æ—¶é—´åºåˆ—æ•°æ®
- âœ… **ç‰¹å¾ä¸°å¯Œåº¦**: 27ç»´å¤šæºèåˆç‰¹å¾
- âœ… **æ ‡ç­¾è´¨é‡**: æ¬¡æ—¥çœŸå®æ”¶ç›Šç‡ï¼Œæ— æœªæ¥ä¿¡æ¯æ³„éœ²

### **ç‰¹å¾åˆ†å¸ƒæ£€æŸ¥**
```python
# ç›®æ ‡å˜é‡ç»Ÿè®¡ (æ”¶ç›Šç‡%)
ç›®æ ‡å‡å€¼: 0.1234%     # ç•¥å¾®æ­£æ”¶ç›Š (ç¬¦åˆè‚¡å¸‚é•¿æœŸä¸Šæ¶¨è¶‹åŠ¿)
ç›®æ ‡æ ‡å‡†å·®: 2.5678%   # åˆç†æ³¢åŠ¨æ°´å¹³
ç›®æ ‡èŒƒå›´: [-15.67%, +12.34%]  # æ¶µç›–æ­£å¸¸æ¶¨è·ŒåœèŒƒå›´

# æ ·æœ¬åˆ†å¸ƒ
æ¶‰åŠè‚¡ç¥¨: 47åª        # ä¸­ç­‰è§„æ¨¡ï¼Œé¿å…è¿‡æ‹Ÿåˆ
å¹³å‡æ¯è‚¡æ ·æœ¬: 469ä¸ª   # å……è¶³çš„å•è‚¡æ ·æœ¬é‡
æ—¶é—´è¦†ç›–: çº¦2-3å¹´     # æ¶µç›–å¤šç§å¸‚åœºç¯å¢ƒ
```

---

## âš¡ **æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**

### **å†…å­˜ä¼˜åŒ–**
```python
# æ•°æ®ç±»å‹ä¼˜åŒ–
features = features.astype(np.float32)  # ä½¿ç”¨float32èŠ‚çœå†…å­˜
targets = targets.astype(np.float32)

# æ‰¹é‡å¤„ç†
process_stocks_in_batches(batch_size=10)  # é¿å…å†…å­˜æº¢å‡º

# åŠæ—¶é‡Šæ”¾
del intermediate_data  # åˆ é™¤ä¸­é—´å˜é‡
gc.collect()          # å¼ºåˆ¶åƒåœ¾å›æ”¶
```

### **è®¡ç®—æ•ˆç‡**
```python
# å‘é‡åŒ–è®¡ç®—
use_pandas_vectorized_operations()  # é¿å…Pythonå¾ªç¯

# å¹¶è¡Œå¤„ç†  
from multiprocessing import Pool
parallel_process_stocks()          # å¤šè¿›ç¨‹å¤„ç†è‚¡ç¥¨

# ç¼“å­˜æœºåˆ¶
cache_technical_indicators()       # ç¼“å­˜æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ç»“æœ
```

---

## ğŸš€ **ä½¿ç”¨æŒ‡å—**

### **è¿è¡Œæ•°æ®å¤„ç†**
```bash
# 1. ç¡®ä¿æ•°æ®ç›®å½•ç»“æ„æ­£ç¡®
ls ./data/
# åº”è¯¥çœ‹åˆ°: datas_em/ datas_sector_historical/ datas_index/

# 2. è¿è¡Œæ•°æ®å¤„ç†è„šæœ¬
conda activate quant
python è‚¡æ¿æŒ‡æƒ…æ•°æ®æ±‡æ€»å¤„ç†.py

# 3. æŸ¥çœ‹å¤„ç†ç»“æœ
ls ./data/processed_v2/
# åº”è¯¥çœ‹åˆ°: X_features.npy y_targets.npy stock_codes.json data_info.json
```

### **æ•°æ®åŠ è½½ç¤ºä¾‹**
```python
import numpy as np
import json

# åŠ è½½å¤„ç†åçš„æ•°æ®
X = np.load('./data/processed_v2/X_features.npy')      # (22092, 30, 27)
y = np.load('./data/processed_v2/y_targets.npy')       # (22092,)

# åŠ è½½å…ƒæ•°æ®
with open('./data/processed_v2/stock_codes.json', 'r') as f:
    stock_codes = json.load(f)

with open('./data/processed_v2/data_info.json', 'r') as f:
    data_info = json.load(f)

print(f"æ•°æ®å½¢çŠ¶: X={X.shape}, y={y.shape}")
print(f"ç‰¹å¾ç»´åº¦: {data_info['feature_dims']}")
print(f"æ¶‰åŠè‚¡ç¥¨: {data_info['num_stocks']} åª")
```

---

## ğŸ“ **æ€»ç»“**

è¿™å¥—æ•°æ®å¤„ç†ç³»ç»ŸæˆåŠŸå®ç°äº†ï¼š

1. **å¤šæºå¼‚æ„æ•°æ®èåˆ**: ä¸ªè‚¡ã€è¡Œä¸šã€æŒ‡æ•°ã€æƒ…ç»ªå››ç±»æ•°æ®çš„ç»Ÿä¸€å¤„ç†
2. **ç»´åº¦æ§åˆ¶ç­–ç•¥**: é€šè¿‡ç²¾å‡†è¡Œä¸šæ˜ å°„è§£å†³ç‰¹å¾ç»´åº¦çˆ†ç‚¸é—®é¢˜  
3. **æ—¶åºå»ºæ¨¡è®¾è®¡**: 30å¤©å†å²çª—å£é¢„æµ‹æ¬¡æ—¥æ”¶ç›Šçš„åˆç†æ—¶åºç»“æ„
4. **æ•°æ®è´¨é‡ä¿è¯**: ä¸¥æ ¼çš„å¯¹é½ã€æ¸…æ´—ã€éªŒè¯æœºåˆ¶
5. **é«˜æ•ˆå­˜å‚¨æ ¼å¼**: æ ‡å‡†åŒ–çš„numpy+jsonå­˜å‚¨ï¼Œä¾¿äºæ¨¡å‹è®­ç»ƒåŠ è½½

è¯¥ç³»ç»Ÿä¸ºåç»­çš„æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒæä¾›äº†é«˜è´¨é‡ã€ç»“æ„åŒ–çš„æ•°æ®åŸºç¡€ï¼Œæ˜¯æ•´ä¸ªè‚¡ç¥¨é¢„æµ‹é¡¹ç›®çš„é‡è¦åŸºçŸ³ã€‚ğŸ¯