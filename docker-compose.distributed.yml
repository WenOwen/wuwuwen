version: '3.8'

# Dockerè·¨ç½‘ç»œéƒ¨ç½²æ–¹æ¡ˆ - ä»£ç å’Œæ•°æ®åˆ†ç¦»ï¼Œæ”¯æŒäº‘ç«¯æ•°æ®ä¼ è¾“
# é€‚ç”¨äºåŸç”µè„‘å’ŒæœåŠ¡å™¨ä¸åœ¨åŒä¸€å±€åŸŸç½‘çš„åœºæ™¯

services:
  # AIè‚¡å¸‚é¢„æµ‹ä¸»æœåŠ¡
  stock-prediction:
    build: .
    container_name: wuwuquant-app
    ports:
      - "8000:8000"  # APIæœåŠ¡
      - "8501:8501"  # Webç•Œé¢
    volumes:
      - ./datas_em:/app/datas_em      # æ•°æ®ç›®å½•
      - ./models:/app/models          # æ¨¡å‹ç›®å½•
      - ./logs:/app/logs              # æ—¥å¿—ç›®å½•
    environment:
      - PYTHONPATH=/app
      - REDIS_HOST=redis
      # æ•°æ®æºé…ç½®
      - DATA_SOURCE_TYPE=${DATA_SOURCE_TYPE:-auto}
      - DATA_PACKAGE_URL=${DATA_PACKAGE_URL:-}
      - AUTO_DOWNLOAD_DATA=${AUTO_DOWNLOAD_DATA:-true}
    depends_on:
      - redis
    restart: unless-stopped
    command: >
      sh -c "
        echo 'ğŸš€ å¯åŠ¨AIè‚¡å¸‚é¢„æµ‹ç³»ç»Ÿ...' &&
        python data_downloader.py &&
        echo 'âœ… æ•°æ®å‡†å¤‡å®Œæˆï¼Œå¯åŠ¨æœåŠ¡...' &&
        uvicorn prediction_service:app --host 0.0.0.0 --port 8000 &
        streamlit run streamlit_app.py --server.port 8501 --server.address 0.0.0.0
      "

  # Redisç¼“å­˜æœåŠ¡
  redis:
    image: redis:7-alpine
    container_name: wuwuquant-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru

volumes:
  redis_data:

# ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ .env ç¤ºä¾‹:
# ç™¾åº¦ç½‘ç›˜æ–¹æ¡ˆ
# DATA_SOURCE_TYPE=baidu
# DATA_PACKAGE_URL=https://pan.baidu.com/s/xxxxx
# 
# é˜¿é‡Œäº‘OSSæ–¹æ¡ˆ  
# DATA_SOURCE_TYPE=aliyun
# DATA_PACKAGE_URL=oss://your-bucket/package.tar.gz
#
# è‡ªåŠ¨æ£€æµ‹
# DATA_SOURCE_TYPE=auto
# AUTO_DOWNLOAD_DATA=true